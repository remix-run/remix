# Fix source map paths to match URL structure

Source maps currently contain filesystem-relative paths, causing browser dev tools to organize the Sources panel tree incorrectly. The tree structure doesn't match the Network panel or actual URL structure, creating a confusing developer experience.

**Current situation:**

Source maps are generated by esbuild with filesystem-relative paths like `../../packages/dev-assets-middleware/src/lib/hmr-runtime.module.ts`. Even though `sourcesContent` is embedded (so sources are technically available), the browser uses these paths to organize the **dev tools Sources panel tree**, creating a messy structure that doesn't match how files are actually served.

**What the tree looks like now (broken):**

```
├── packages/               (from relative ../../packages path)
│   └── dev-assets-middleware/
├── app/app/                (duplicate nested structure)
│   └── components/
├── __@workspace/packages/  (correct structure)
└── localhost:44100/        (mixing URLs with filesystem paths)
```

**What we want (clean, matches Network panel):**

```
├── __@remix/
│   └── hmr-runtime.ts
├── __@workspace/
│   └── packages/
│       ├── component/
│       └── dev-assets-middleware/
└── assets/
    └── components/
        └── Counter.tsx
```

**Examples:**

- **HMR runtime**: Served at `/__@remix/hmr-runtime.ts`, source map says `../../virtual/hmr-runtime.ts`

  - Creates weird folder structure at root level in dev tools tree
  - Should say: `/__@remix/hmr-runtime.ts`

- **App files**: Served at `/assets/components/Counter.tsx`, source map says `../components/Counter.tsx`
  - Creates `app/` nested folders
  - Should say: `/assets/components/Counter.tsx`

**Why this matters:**

- Dev tools Sources tree doesn't match Network panel structure
- Hard to find files in dev tools (they're not where you expect)
- Duplicate/confusing folder structures
- Inconsistent organization across different file types
- Poor developer experience when debugging

**Solution approach:**

In an **unbundled dev setup**, each source file has its own URL where it's served. The source map's `sources` array should reference that **same URL** (not a filesystem path).

After esbuild transformation:

1. Parse the inline source map from transformed code
2. Replace the `sources` array with the `sourceUrl` parameter (the URL where this file is served)
3. Preserve `sourcesContent` (actual TypeScript source - already embedded by esbuild)
4. Re-encode and replace the source map

This needs to happen in the `transformSource` function after esbuild but before caching.

**Implementation notes:**

- Source maps are inline base64-encoded JSON
- The `sourceUrl` parameter in `transformSource` tells us exactly where the file will be served
- Simply replace `sources` array with `[sourceUrl]`
- Keep `sourcesContent` as-is (the actual source code)
- Works for workspace files, app files, and HMR runtime

**Acceptance Criteria:**

- [x] Dev tools Sources tree structure matches Network panel URLs
- [x] No duplicate or weirdly nested folder structures
- [x] HMR runtime shows as `__@remix/hmr-runtime.ts` in Sources tree
- [x] Workspace files show under `__@workspace/packages/` in Sources tree
- [x] App files show under their serve path (e.g., `/assets/`) in Sources tree
- [x] Can still set breakpoints and debug TypeScript (sourcesContent preserved)
- [x] Can still step through TypeScript code
- [x] Errors still show correct TypeScript line numbers
- [x] All existing tests still pass
- [x] Source map correction is cached (no performance regression)

---

## What was done

### Fix 1: Source Map URL Paths (`fixSourceMapPaths`)

**Location**: `packages/dev-assets-middleware/src/lib/assets.ts`

Created `fixSourceMapPaths()` function that:

- Parses inline source maps from transformed code
- Replaces filesystem-relative paths in the `sources` array with URL paths
- Preserves `sourcesContent` (the actual TypeScript source)
- Re-encodes and embeds the fixed source map

**Bug Fix**: Added multiline flag (`m`) to regex patterns in both `parseInlineSourceMap()` and `fixSourceMapPaths()` so `$` matches end of line, not just end of string.

**Integration**: Applied in `transformSource()` after esbuild transformation and import rewriting, before caching. This ensures the fix is cached with the transformed code (no performance regression).

**Tests**: Added 8 comprehensive unit tests covering app files, HMR runtime, workspace files, error handling, and edge cases.

### Fix 2: HMR Transform Source Content Preservation

**Problem Discovered**: During testing, noticed that HMR-transformed files showed intermediate esbuild JavaScript in the browser instead of original TypeScript source.

**Root Cause**: SWC's `print()` function, when chaining source maps via `inputSourceMap`, correctly chains position mappings but replaces `sourcesContent` with the intermediate code being transformed (esbuild JS) instead of preserving the original TypeScript from the input source map.

**Location**: `packages/dev-assets-middleware/src/lib/hmr-transform.ts`

**Solution**: After SWC transformation, manually extract and preserve `sourcesContent` from the esbuild source map (lines 844-871):

```typescript
// Parse input source map to preserve sourcesContent
let parsedInputMap: any = null
if (inputSourceMap) {
  try {
    parsedInputMap = JSON.parse(inputSourceMap)
  } catch {
    parsedInputMap = null
  }
}

// ... SWC print ...

// Fix the source map to preserve original sourcesContent from esbuild
if (result.map && parsedInputMap?.sourcesContent) {
  let outputMap = JSON.parse(result.map)
  outputMap.sourcesContent = parsedInputMap.sourcesContent
  result.map = JSON.stringify(outputMap)
}
```

This preserves the original TypeScript source for browser display while maintaining SWC's correct position mappings.

### Results

Source maps now correctly show:

- **`sources`**: URL paths (e.g., `/app/components/App.tsx`, `/__@remix/hmr-runtime.ts`, `/__@workspace/packages/component/src/jsx-runtime.ts`)
- **`sourcesContent`**: Original TypeScript source with type annotations and JSX
- **Mappings**: Properly chained through esbuild → import rewriting → HMR transform

Browser DevTools Sources panel now shows a clean, unified tree structure matching the Network panel, with original TypeScript source displayed for all files.

**Test Results**: All 143 tests pass (130 unit tests + 13 E2E tests).
