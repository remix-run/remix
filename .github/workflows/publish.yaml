name: Publish

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  check:
    name: Check for release commit
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for release commit with version changes
        id: check
        run: |
          # Must be a Release commit
          if ! git log -1 --format=%s | grep -q '^Release '; then
            echo "is_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Must have actual version changes in package.json files
          has_changes=false
          for pkg in packages/*/package.json; do
            current=$(git show HEAD:"$pkg" 2>/dev/null | grep '"version"' | head -1 || true)
            previous=$(git show HEAD~1:"$pkg" 2>/dev/null | grep '"version"' | head -1 || true)
            if [ -n "$current" ] && [ "$current" != "$previous" ]; then
              has_changes=true
              break
            fi
          done

          echo "is_release=$has_changes" >> $GITHUB_OUTPUT

  publish:
    name: Publish to npm
    needs: check
    if: needs.check.outputs.is_release == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: write # Required for creating tags and GitHub releases
      id-token: write # OIDC ID token is used for authentication with npm/jsr

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Fetch 2 commits so we can compare versions with parent commit
          fetch-depth: 2

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'package.json'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get Playwright Version
        id: playwright-version
        run: echo "version=$(pnpm --filter @remix-run/interaction exec playwright --version | cut -d ' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: cache-browsers
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright Browsers
        if: steps.cache-browsers.outputs.cache-hit != 'true'
        run: pnpm --filter @remix-run/interaction exec playwright install --with-deps

      - name: Run tests
        run: pnpm test

      - name: Build packages
        run: pnpm build

      - name: Publish to npm
        run: pnpm publish --recursive --access public --no-git-checks

      - name: Create tags and GitHub releases
        run: node ./scripts/publish.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
